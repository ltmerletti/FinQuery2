flowchart TD
    subgraph "Module 1: Calculation Planning"
        A["Input: User's Natural Language Question"] --> Z{"AI Agent 1: Conversational AI"};
        Z -- " User request after all required information has been fulfilled " --> B{"AI Agent 2: Calculation Planner"}
        B -- " Outputs Calculation Plan (JSON) " --> C;
    end

    subgraph "Module 2: Data Retrieval & Repair Loop"
        C -- " Defines required data points " --> D["Data Execution Engine"];
        D --> E{"Data Retrieval Succeeded?"};
        E -- " No " --> F{"AI Agent 2: SQL Repair Agent"};
        F -- " Receives Failed Query, Error & Schema " --> G["Generate Corrected SQL Query"];
        G -- " Sends corrected query to be re-run " --> D;
        E -- " Yes " --> H["Retrieved Financial Data"];
    end

    subgraph "Module 3: Secure Execution & Final Output"
        H -- " Sends Data to Executor " --> I;
        C -- " Sends Calculation Steps to Executor " --> I;
        I["Secure Calculation Engine"] --> J["Execute Steps on Data"];
        J --> K["Return Final Output with Execution Trace"];
    end